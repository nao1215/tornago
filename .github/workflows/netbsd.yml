name: NetBSD Test

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    name: NetBSD unit test
    strategy:
      matrix:
        os:
          - name: netbsd
            architecture: x86-64
            version: "10.1"

    steps:
      - uses: actions/checkout@v6

      - name: Test on ${{ matrix.os.name }}
        uses: cross-platform-actions/action@v0.30.0
        with:
          operating_system: ${{ matrix.os.name }}
          architecture: ${{ matrix.os.architecture }}
          version: ${{ matrix.os.version }}
          shell: bash
          memory: 8G
          cpu_count: 4
          run: |
            sudo pkgin -y install go tor mozilla-rootcerts gmake git
            # Install certificates (ignore error if already exists)
            sudo /usr/pkg/sbin/mozilla-rootcerts install || true

            # Find the Go installation path dynamically and add to PATH
            GO_BIN=$(find /usr/pkg -name "go" -type f -path "*/bin/go" | head -n 1)

            if [ -z "$GO_BIN" ]; then
              echo "Error: Go binary not found"
              exit 1
            fi

            GO_DIR=$(dirname "$GO_BIN")
            export PATH="$GO_DIR:$PATH"

            git config --global --add safe.directory /home/runner/work/tornago/tornago
            echo "Using Go at: $GO_BIN"
            go version
            tor --version

            go mod download
            gmake integration-test
        env:
          TORNAGO_INTEGRATION: "1"
